name: "Auto Create PR: feature -> develop"

on:
  push:
    # Trigger for branches that start with 'feature/' or 'feature'
    branches:
      - 'feature/**'
      - 'feature*'

permissions:
  contents: write

jobs:
  create-pr:
    name: Create PR to develop
    runs-on: ubuntu-latest

    steps:
      - name: Create PR from feature branch into develop (if none exists)
        uses: actions/github-script@v6
        with:
          script: |
            const headRef = context.ref.replace('refs/heads/', '');
            const head = headRef;
            const base = 'develop';
            const title = `Automated PR: ${head} â†’ ${base}`;
            const body = `This pull request was automatically created from branch \\`${head}\\` into \\`${base}\\` by workflow \\`.github/workflows/create-pr-to-develop.yml\\`.`;

            // Avoid creating PRs when actor is the GitHub Actions bot to reduce loops
            if (context.actor === 'github-actions') {
              console.log('Triggered by github-actions; skipping PR creation to avoid loops.');
              return;
            }

            const { owner, repo } = context.repo;

            // Check for an existing open PR from this head to base
            const existing = await github.rest.pulls.list({ owner, repo, head: `${owner}:${head}`, base, state: 'open' });
            if (existing.data && existing.data.length > 0) {
              console.log(`An open PR already exists: ${existing.data[0].html_url}`);
              return;
            }

            // Create PR
            try {
              const pr = await github.rest.pulls.create({ owner, repo, title, head, base, body });
              console.log(`Created PR: ${pr.data.html_url}`);
            } catch (err) {
              console.log(`Failed to create PR: ${err.message}`);
              core.setFailed?.(err.message);
            }
